â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… è‡ªå®šä¹‰å¤©æ°”å·¥å…·å·²åˆ›å»ºå®Œæˆï¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ æ–°åˆ›å»ºçš„æ–‡ä»¶:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. weather_tool/weather_provider.py    - å¤©æ°”å·¥å…·å®ç°
2. weather_tool/__init__.py            - Package åˆå§‹åŒ–
3. test_weather_tool.py                - æµ‹è¯•å®¢æˆ·ç«¯
4. quick-test-weather-tool.sh          - ä¸€é”®å¯åŠ¨è„šæœ¬
5. weather-tool-config.yaml            - Server é…ç½® (å¯é€‰)
6. WEATHER_TOOL_README.md              - å®Œæ•´æ–‡æ¡£

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš€ å¿«é€Ÿå¼€å§‹ (3 æ­¥)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

cd examples/metrics-demo

# æ–¹å¼ 1: ä¸€é”®å¯åŠ¨ (æ¨è)
./quick-test-weather-tool.sh

# æ–¹å¼ 2: æ‰‹åŠ¨è¿è¡Œ
docker-compose up -d
export USE_SERVER_MODE="false"
export OTEL_EXPORTER_OTLP_ENDPOINT="http://localhost:4318"
export OTEL_EXPORTER_OTLP_PROTOCOL="http/protobuf"
python test_weather_tool.py

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ å·¥ä½œæµç¨‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

test_weather_tool.py
  â†“ è°ƒç”¨ get_weather("Tokyo")
WeatherToolProvider (è‡ªå®šä¹‰å·¥å…·)
  â†“ è¿”å› mock å¤©æ°”æ•°æ®
  â†“ ç»è¿‡ ToolRuntimeRouter (å·²æ’æ¡©!)
  â†“ è‡ªåŠ¨è®°å½• metrics:
      - llama_stack_tool_runtime_invocations_total
      - llama_stack_tool_runtime_duration_seconds
Metrics å¯¼å‡º
  â†“ OTLP â†’ Prometheus â†’ Grafana
ä½ çœ‹åˆ°å¤©æ°”å·¥å…·çš„ metrics! ğŸ“ˆ

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š é¢„æœŸ Metrics
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

åœ¨ Grafana (http://localhost:3000) ä¸­çœ‹åˆ°:

1. Tool Invocation Rate
   - æ˜¾ç¤º ~1 req/s
   - tool_name="get_weather"

2. Success vs Error Rate
   - æˆåŠŸç‡: ~100%
   - å¤±è´¥: ~0%

3. Tool Latency
   - P50: ~0.01s (mock æ•°æ®å¾ˆå¿«)
   - P95: ~0.02s
   - P99: ~0.03s

4. Total Invocations
   - 2åˆ†é’Ÿè¿è¡Œ: ~120 æ¬¡è°ƒç”¨

5. Invocations by Tool Group
   - toolgroup_id="weather"

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ å·¥å…·ç‰¹æ€§
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

WeatherToolProvider å®ç°:

âœ… å·¥å…·å®šä¹‰
   - åç§°: get_weather
   - è¾“å…¥: city (å¿…éœ€), units (å¯é€‰: celsius/fahrenheit)
   - è¾“å‡º: å¤©æ°”æ•°æ® (æ¸©åº¦ã€æ¹¿åº¦ã€é£é€Ÿã€çŠ¶å†µ)

âœ… è¾“å…¥éªŒè¯
   - æ£€æŸ¥ city å‚æ•°
   - éªŒè¯ units å€¼
   - è¿”å›é”™è¯¯ä¿¡æ¯ (error_code, error_message)

âœ… Mock æ•°æ®ç”Ÿæˆ
   - éšæœºæ¸©åº¦ã€æ¹¿åº¦ã€é£é€Ÿ
   - å¤šç§å¤©æ°”çŠ¶å†µ (æ™´å¤©ã€å¤šäº‘ã€é›¨å¤©ç­‰)
   - æ”¯æŒæ‘„æ°åº¦å’Œåæ°åº¦

âœ… Metrics è‡ªåŠ¨è®°å½•
   - è°ƒç”¨æ¬¡æ•° (æŒ‰ tool_name, status)
   - è°ƒç”¨å»¶è¿Ÿ (histogram)
   - æˆåŠŸ/å¤±è´¥åˆ†ç±»

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ç¤ºä¾‹è¾“å‡º
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ§åˆ¶å°:

==============================================================
ğŸ¦™ Llama Stack - Weather Tool Metrics Test
==============================================================

âœ… OTLP Export: http://localhost:4318

ğŸ“š Initializing library mode (no server needed)
âœ… Library client initialized with weather tool

ğŸ“‹ Available tools: 1
   - get_weather (weather)

==============================================================
ğŸš€ Starting weather tool invocation tests
==============================================================
Duration: 120 seconds
Rate: 1.0 requests/second

âœ… get_weather(Tokyo): 0.01s
   Weather in Tokyo:
âœ… get_weather(London): 0.01s
   Weather in London:
âœ… get_weather(Paris): 0.01s
   Weather in Paris:

â±ï¸  10s | Requests: 10 | Success: 10 | Failed: 0 | Rate: 100.0%
â±ï¸  20s | Requests: 20 | Success: 20 | Failed: 0 | Rate: 100.0%
...

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ ä¸ä¹‹å‰æµ‹è¯•çš„å¯¹æ¯”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç‰¹æ€§                â”‚ test_real_tools.py   â”‚ test_weather_tool.py â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·¥å…·æ¥æº            â”‚ è¿œç¨‹ API (Braveç­‰)   â”‚ è‡ªå®šä¹‰ inline        â”‚
â”‚ éœ€è¦ API Keys       â”‚ âœ… éœ€è¦              â”‚ âŒ ä¸éœ€è¦            â”‚
â”‚ éœ€è¦ Server         â”‚ âœ… æˆ– library æ¨¡å¼   â”‚ âŒ Library æ¨¡å¼å³å¯  â”‚
â”‚ å“åº”æ—¶é—´            â”‚ çœŸå®ç½‘ç»œå»¶è¿Ÿ (~1s)   â”‚ Mock æå¿« (~0.01s)   â”‚
â”‚ æ•°æ®çœŸå®æ€§          â”‚ çœŸå®æ•°æ®             â”‚ Mock éšæœºæ•°æ®        â”‚
â”‚ ç”¨é€”                â”‚ æµ‹è¯•çœŸå®å·¥ä½œè´Ÿè½½     â”‚ æµ‹è¯•è‡ªå®šä¹‰å·¥å…·       â”‚
â”‚ å¤æ‚åº¦              â”‚ éœ€è¦å¤–éƒ¨ä¾èµ–         â”‚ å®Œå…¨ç‹¬ç«‹             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ› ï¸ è‡ªå®šä¹‰ä½ çš„å·¥å…·
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. æ›¿æ¢ Mock æ•°æ®ä¸ºçœŸå® API:

   åœ¨ weather_provider.py ä¸­:

   async def invoke_tool(self, ...):
       city = kwargs.get("city")

       # è°ƒç”¨çœŸå® API (ä¾‹å¦‚ OpenWeatherMap)
       api_key = os.environ.get("OPENWEATHER_API_KEY")
       async with httpx.AsyncClient() as client:
           response = await client.get(
               f"https://api.openweathermap.org/data/2.5/weather?q={city}&appid={api_key}"
           )
           data = response.json()

       return ToolInvocationResult(content=format_weather(data))

2. æ·»åŠ æ›´å¤šå·¥å…·:

   - get_forecast (5å¤©é¢„æŠ¥)
   - get_air_quality (ç©ºæ°”è´¨é‡)
   - get_weather_alerts (å¤©æ°”è­¦æŠ¥)

3. åˆ›å»ºå…¶ä»–ç±»å‹çš„å·¥å…·:

   - æœç´¢å·¥å…· (Google, Wikipedia)
   - è®¡ç®—å·¥å…· (è®¡ç®—å™¨, å•ä½è½¬æ¢)
   - æ•°æ®åº“å·¥å…· (SQL æŸ¥è¯¢, Redis)
   - æ–‡ä»¶å·¥å…· (è¯»å†™æ–‡ä»¶, å›¾ç‰‡å¤„ç†)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ› å¸¸è§é—®é¢˜
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ ImportError: No module named 'examples'
   â†’ ç¡®ä¿ä»é¡¹ç›®æ ¹ç›®å½•è¿è¡Œï¼Œæˆ–è®¾ç½® PYTHONPATH

âŒ Connection refused (port 4318)
   â†’ å¯åŠ¨ Docker stack: docker-compose up -d
   â†’ æ£€æŸ¥ collector: docker-compose ps

âŒ Grafana æ²¡æœ‰æ•°æ®
   â†’ è®¾ç½®æ—¶é—´èŒƒå›´: "Last 15 minutes"
   â†’ å¯ç”¨è‡ªåŠ¨åˆ·æ–°: 5s
   â†’ æ£€æŸ¥ Prometheus: http://localhost:9090

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“Š PromQL æŸ¥è¯¢ç¤ºä¾‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

åœ¨ Prometheus (http://localhost:9090) ä¸­æŸ¥è¯¢:

# å¤©æ°”å·¥å…·è°ƒç”¨æ€»æ•°
llama_stack_tool_runtime_invocations_total{tool_name="get_weather"}

# æ¯ç§’è°ƒç”¨ç‡
rate(llama_stack_tool_runtime_invocations_total{tool_name="get_weather"}[1m])

# æˆåŠŸç‡
sum(rate(llama_stack_tool_runtime_invocations_total{tool_name="get_weather",status="success"}[1m]))
/
sum(rate(llama_stack_tool_runtime_invocations_total{tool_name="get_weather"}[1m]))

# P95 å»¶è¿Ÿ
histogram_quantile(0.95,
  rate(llama_stack_tool_runtime_duration_seconds_bucket{tool_name="get_weather"}[1m])
)

# æŒ‰åŸå¸‚åˆ†ç»„ (å¦‚æœæ·»åŠ  city label)
sum by (city) (llama_stack_tool_runtime_invocations_total{tool_name="get_weather"})

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ å­¦ä¹ æˆæœ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

é€šè¿‡è¿™ä¸ªç¤ºä¾‹ï¼Œä½ å­¦ä¼šäº†:

âœ… åˆ›å»ºè‡ªå®šä¹‰ llama-stack tool provider
âœ… å®ç° ToolRuntime å’Œ ToolGroupsProtocolPrivate æ¥å£
âœ… å®šä¹‰å·¥å…·çš„ input/output JSON schema
âœ… å®ç° list_runtime_tools å’Œ invoke_tool æ–¹æ³•
âœ… ä½¿ç”¨ library æ¨¡å¼æµ‹è¯•å·¥å…· (æ— éœ€ server)
âœ… è‡ªåŠ¨è®°å½•å’Œå¯¼å‡º OpenTelemetry metrics
âœ… åœ¨ Prometheus å’Œ Grafana ä¸­å¯è§†åŒ– metrics

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“š å®Œæ•´æµ‹è¯•æµç¨‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç°åœ¨ä½ æœ‰ 3 ç§æµ‹è¯• Tool Runtime Metrics çš„æ–¹å¼:

1. ğŸ“ æ¨¡æ‹Ÿæµ‹è¯• (generate_metrics.py)
   - å¿«é€ŸéªŒè¯ç›‘æ§ç³»ç»Ÿ
   - æ— éœ€çœŸå®å·¥å…·æˆ– API

2. ğŸŒ çœŸå®å·¥å…·æµ‹è¯• (test_real_tools.py)
   - è°ƒç”¨çœŸå®å¤–éƒ¨ API (Brave Search, Tavily ç­‰)
   - ç”ŸæˆçœŸå®æ€§èƒ½æ•°æ®
   - éœ€è¦ API keys å’Œ server

3. ğŸ› ï¸ è‡ªå®šä¹‰å·¥å…·æµ‹è¯• (test_weather_tool.py) â† æ–°å¢!
   - æµ‹è¯•ä½ è‡ªå·±åˆ›å»ºçš„å·¥å…·
   - å®Œå…¨ç‹¬ç«‹ï¼Œæ— éœ€å¤–éƒ¨ä¾èµ–
   - æœ€é€‚åˆå­¦ä¹ å’Œå¼€å‘

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç°åœ¨å¼€å§‹æµ‹è¯•ä½ çš„è‡ªå®šä¹‰å¤©æ°”å·¥å…·:

  cd examples/metrics-demo
  ./quick-test-weather-tool.sh

æˆ–æ‰‹åŠ¨è¿è¡Œ:

  export USE_SERVER_MODE="false"
  export OTEL_EXPORTER_OTLP_ENDPOINT="http://localhost:4318"
  export OTEL_EXPORTER_OTLP_PROTOCOL="http/protobuf"
  python test_weather_tool.py

ç„¶åæŸ¥çœ‹ metrics:
  ğŸ“Š Prometheus: http://localhost:9090
  ğŸ“ˆ Grafana:    http://localhost:3000 (admin/admin)

Happy coding! ğŸ¦™ğŸ“ŠğŸŒ¤ï¸
